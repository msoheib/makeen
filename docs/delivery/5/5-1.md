# 5-1 Setup Supabase real-time subscriptions

[Back to task list](mdc:tasks.md)

## Description

Configure Supabase real-time subscriptions to monitor database changes for critical events such as new maintenance requests, payment vouchers, tenant applications, and other user activities. This forms the foundation of the notification system by detecting when events occur that require user notification.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2024-12-22 21:47:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2024-12-22 21:47:00 | Status Update | Proposed | Agreed | Task approved for implementation | User |
| 2024-12-22 21:47:00 | Status Update | Agreed | InProgress | Started implementation | AI_Agent |
| 2024-12-22 22:02:00 | Status Update | InProgress | Review | Implementation completed - real-time service and hooks created | AI_Agent |

## Requirements

### Functional Requirements
- Configure Supabase real-time client initialization
- Set up subscriptions for maintenance_requests table changes
- Set up subscriptions for vouchers table changes (new receipts/payments)
- Set up subscriptions for property_reservations table changes
- Set up subscriptions for contracts table changes (new tenant agreements)
- Implement proper subscription lifecycle management (subscribe/unsubscribe)
- Add error handling for real-time connection issues
- Create real-time event handlers for each table
- Implement real-time connection status monitoring

### Technical Requirements
- Use Supabase real-time JavaScript client
- Implement proper authentication for real-time subscriptions
- Create reusable real-time service layer
- Add TypeScript types for real-time events
- Implement subscription cleanup on component unmount
- Handle real-time reconnection automatically

### Performance Requirements
- Minimize database change listeners to essential tables only
- Implement efficient event filtering based on user roles
- Ensure real-time subscriptions don't impact app performance
- Add connection pooling and optimization

## Implementation Plan

### Phase 1: Real-time Service Setup
1. **Install dependencies** - Ensure Supabase real-time is available
2. **Create real-time service** (`lib/realtime.ts`) - Centralized real-time management
3. **Configure authentication** - Ensure real-time client uses proper authentication
4. **Add connection monitoring** - Track real-time connection status

### Phase 2: Table Subscriptions
1. **Maintenance requests** - Monitor for new/updated maintenance requests
2. **Financial vouchers** - Monitor for new receipt/payment vouchers
3. **Property reservations** - Monitor for new reservation requests
4. **Contracts** - Monitor for new tenant agreements and status changes

### Phase 3: Event Processing
1. **Event handlers** - Process real-time events and determine notification requirements
2. **User filtering** - Filter events based on user roles and permissions
3. **Event transformation** - Convert database changes to notification data
4. **Error handling** - Graceful handling of real-time connection issues

### Phase 4: Integration
1. **Hook integration** - Create useRealtime custom hook for components
2. **Component integration** - Add real-time subscriptions to relevant screens
3. **Performance optimization** - Ensure efficient subscription management
4. **Testing** - Verify real-time events trigger correctly

## Verification

### Test Scenarios
1. **Real-time connection** - Verify Supabase real-time client connects successfully
2. **Maintenance requests** - Create new maintenance request, verify real-time event received
3. **Payment vouchers** - Create new payment voucher, verify real-time event received
4. **Property reservations** - Create new reservation, verify real-time event received
5. **Contract changes** - Update contract status, verify real-time event received
6. **Connection recovery** - Test reconnection after network interruption
7. **Multiple subscriptions** - Verify multiple table subscriptions work simultaneously
8. **Authentication** - Verify real-time subscriptions respect user authentication
9. **Performance** - Ensure real-time subscriptions don't degrade app performance
10. **Cleanup** - Verify subscriptions properly unsubscribe on component unmount

### Success Criteria
- ✅ Real-time client initializes successfully with authentication
- ✅ All target table subscriptions (maintenance_requests, vouchers, property_reservations, contracts) active
- ✅ Real-time events received within 2 seconds of database changes
- ✅ Event handlers process changes and extract notification-relevant data
- ✅ Connection status monitoring works and handles reconnection
- ✅ No memory leaks from unmanaged subscriptions
- ✅ Real-time functionality doesn't impact app performance
- ✅ Error handling gracefully manages connection issues
- ✅ User role-based event filtering works correctly
- ✅ TypeScript types ensure type safety for real-time events

## Files Modified

### New Files
- `lib/realtime.ts` - Real-time service and subscription management
- `hooks/useRealtime.ts` - Custom hook for component-level real-time integration

### Modified Files
- `lib/api.ts` - Add real-time event processing functions
- Package.json - Ensure Supabase real-time dependencies

### Database Tables Monitored
- `maintenance_requests` - New requests, status changes
- `vouchers` - New receipt/payment vouchers, status changes  
- `property_reservations` - New reservations, status changes
- `contracts` - New contracts, status/renewal changes 