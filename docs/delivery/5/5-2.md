# 5-2 Implement Expo push notifications

[Back to task list](mdc:tasks.md)

## Description

Implement Expo push notification service to deliver real-time notifications to users when the app is in background or closed. This includes setting up push notification permissions, registering devices with Expo's push service, and creating a notification service that integrates with the real-time events from task 5-1.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2024-12-22 22:05:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2024-12-22 22:05:00 | Status Update | Proposed | Agreed | Task approved for implementation | User |
| 2024-12-22 22:05:00 | Status Update | Agreed | InProgress | Started implementation | AI_Agent |

## Requirements

### Functional Requirements
- Request and handle push notification permissions from users
- Register device with Expo push notification service
- Send push notifications when real-time events occur
- Handle notification interactions (tap to navigate to relevant screen)
- Support different notification types based on event types
- Queue and retry failed notification deliveries
- Handle notification permissions gracefully (ask, don't ask again, denied)

### Technical Requirements
- Install and configure expo-notifications package
- Create push notification service layer
- Integrate with real-time event system from task 5-1
- Implement notification scheduling and delivery
- Add notification sound and vibration patterns
- Create notification action handlers
- Support notification categories (maintenance, finance, contracts, etc.)

### Platform Requirements
- Support both iOS and Android push notifications
- Handle platform-specific notification behaviors
- Implement proper notification badges and icons
- Follow platform notification guidelines
- Support rich notifications with actions

## Implementation Plan

### Phase 1: Expo Notifications Setup
1. **Install Dependencies** - Add expo-notifications to project
2. **Configure Permissions** - Request and handle notification permissions
3. **Device Registration** - Register device with Expo push service
4. **Basic Service Setup** - Create notification service infrastructure

### Phase 2: Notification Service Integration
1. **Service Layer** - Create `lib/notifications.ts` for push notification management
2. **Event Integration** - Connect to real-time events from task 5-1
3. **Notification Formatting** - Create notification content based on event types
4. **Delivery Logic** - Implement notification sending and queuing

### Phase 3: Notification Interactions
1. **Tap Handlers** - Navigate to relevant screens when notifications are tapped
2. **Action Buttons** - Add quick actions to notifications (view, dismiss, etc.)
3. **Deep Linking** - Navigate to specific items (property, tenant, voucher, etc.)
4. **Notification History** - Track sent notifications for debugging

### Phase 4: Enhanced Features
1. **Notification Categories** - Different styles for maintenance, finance, contracts
2. **Rich Content** - Include images and detailed information
3. **Scheduling** - Support for scheduled and recurring notifications
4. **User Preferences** - Respect notification settings from user preferences

## Verification

### Test Scenarios
1. **Permission Flow** - Request permissions on first app launch
2. **Device Registration** - Verify device token is obtained and stored
3. **Real-time Integration** - Create database change and verify push notification sent
4. **Background Delivery** - Test notifications when app is backgrounded/closed
5. **Notification Tap** - Tap notification and verify correct screen navigation
6. **Permission Denied** - Handle gracefully when user denies permissions
7. **Network Offline** - Queue notifications and send when connection restored
8. **Multiple Events** - Handle rapid succession of events without spam
9. **App Foreground** - Handle when app is in foreground (show in-app vs push)
10. **Platform Differences** - Test on both iOS and Android devices

### Success Criteria
- ✅ Notification permissions requested and handled properly
- ✅ Device successfully registered with Expo push service
- ✅ Push notifications delivered when real-time events occur
- ✅ Notifications display correct content and formatting
- ✅ Tapping notifications navigates to correct screens
- ✅ Background and closed app notifications work correctly
- ✅ No notification spam (proper throttling and grouping)
- ✅ Platform-specific behaviors work correctly
- ✅ Error handling for failed notification delivery
- ✅ Integration with user notification preferences

## Files Modified

### New Files
- `lib/notifications.ts` - Push notification service and management
- `hooks/useNotifications.ts` - Custom hook for notification functionality

### Modified Files
- `package.json` - Add expo-notifications dependency
- `lib/realtime.ts` - Integration with notification service
- `app.json` - Notification configuration
- App entry point - Permission handling and service initialization

### Platform-Specific Configuration
- **iOS:** Notification categories, sound files, permission descriptions
- **Android:** Notification channels, icons, importance levels

## Integration Points
- **Real-time Service:** Trigger notifications from database events
- **Navigation System:** Deep linking from notification taps
- **User Preferences:** Respect notification settings from settings screen
- **Error Handling:** Graceful degradation when push service unavailable

## Notification Event Types
- **Maintenance Request:** New urgent maintenance requests
- **Payment Voucher:** New rent payments received
- **Contract Changes:** Contract renewals, expirations
- **Property Updates:** Status changes, new reservations
- **System Alerts:** Important system notifications 