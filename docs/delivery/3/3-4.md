# 3-4 Implement VAT invoice management

[Back to task list](mdc:tasks.md)

## Description

Create a comprehensive VAT invoice management system that allows users to generate professional VAT-compliant invoices for property rentals, sales, and services. The system should handle VAT calculations, customer billing, invoice numbering, and integration with the accounting system for proper revenue recognition.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2024-12-22 04:50:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2024-12-22 04:50:00 | Status Update | Proposed | Agreed | Task approved for implementation | User |
| 2024-12-22 04:50:00 | Status Update | Agreed | InProgress | Started implementation | AI_Agent |
| 2024-12-22 05:15:00 | Status Update | InProgress | Review | Completed VAT invoice system with line items, VAT calculation, customer integration, and professional invoice creation form | AI_Agent |

## Requirements

### Core Functionality
1. **VAT Invoice Creation Form**
   - Automatic invoice number generation with format (INV-YYYY-NNNNNN)
   - Customer/tenant selection from profiles
   - Property selection for property-related invoices
   - Service/item description and line items
   - VAT rate configuration (15% standard rate for Saudi Arabia)
   - Due date calculation and payment terms
   - Invoice status management (draft, sent, paid, overdue, cancelled)

2. **Line Item Management**
   - Multiple line items per invoice
   - Item description, quantity, unit price
   - Line total calculation (quantity Ã— unit price)
   - Discount handling (per line or invoice level)
   - VAT calculation per line item
   - Total calculation with VAT

3. **VAT Calculation System**
   - Configurable VAT rates (default 15% for KSA)
   - Line-by-line VAT calculation
   - VAT-exclusive and VAT-inclusive pricing options
   - VAT summary display
   - Net amount, VAT amount, and gross total

4. **Customer Integration**
   - Customer selection from profiles and clients
   - Customer billing details integration
   - Customer VAT registration validation
   - Customer payment history integration

5. **Property Integration**
   - Property selection for rental invoices
   - Property details on invoice
   - Property-based billing integration
   - Automatic rent amount population

### Business Logic Requirements
1. **Invoice Numbering**
   - Sequential invoice number generation
   - Unique invoice numbers per system
   - Year-based numbering reset capability
   - Invoice number uniqueness validation

2. **VAT Compliance**
   - Saudi Arabia VAT regulations compliance
   - Proper VAT calculation and display
   - VAT registration number handling
   - VAT reporting preparation

3. **Due Date Management**
   - Configurable payment terms (30, 60, 90 days)
   - Automatic due date calculation
   - Overdue invoice detection
   - Payment reminder capabilities

4. **Status Management**
   - Invoice lifecycle status tracking
   - Status-based business logic
   - Payment status integration
   - Late payment tracking

### Integration Requirements
1. **Accounting Integration**
   - Revenue recognition in accounting system
   - VAT liability accounting
   - Accounts receivable integration
   - Journal entry generation for invoices

2. **Property Management Integration**
   - Property rent billing automation
   - Property service charge billing
   - Property-based customer assignment

3. **Payment Integration**
   - Payment voucher linking to invoices
   - Payment allocation and tracking
   - Outstanding balance calculation

## Implementation Plan

### 1. Create VAT Invoice Form Screen (`app/finance/invoices/create.tsx`)
- Build comprehensive invoice creation form
- Implement line item management with add/remove functionality
- Add VAT calculation and display system
- Integrate customer and property selection
- Add invoice preview functionality

### 2. Create Invoice Line Item Component (`components/InvoiceLineItem.tsx`)
- Individual line item row with description, quantity, price
- Real-time line total calculation
- VAT calculation per line
- Line item validation and error handling

### 3. Create VAT Calculation Component (`components/VATCalculator.tsx`)
- VAT rate selection and application
- Net, VAT, and gross amount calculation
- VAT summary display
- VAT-inclusive/exclusive toggle

### 4. Enhance Invoices API
- Invoice creation with line items
- VAT calculation backend validation
- Invoice number generation
- Customer and property integration

### 5. Create Invoice Management Screen (`app/finance/invoices/index.tsx`)
- Invoice listing with filtering and search
- Status-based invoice organization
- Invoice preview and editing
- Payment status tracking

## Test Plan

### Unit Testing
- **VAT Calculation**: Test VAT calculation accuracy with various rates
- **Line Items**: Test line item addition, removal, and calculation
- **Invoice Numbering**: Test unique invoice number generation
- **Due Date Calculation**: Test payment terms and due date logic

### Integration Testing
- **Customer Integration**: Test customer selection and billing details
- **Property Integration**: Test property-based invoice generation
- **Accounting Integration**: Test journal entry generation
- **Payment Integration**: Test payment allocation to invoices

### Business Logic Testing
- **VAT Compliance**: Test VAT calculation per Saudi regulations
- **Invoice Lifecycle**: Test status transitions and business rules
- **Payment Tracking**: Test payment allocation and outstanding balances
- **Overdue Detection**: Test overdue invoice identification

### Success Criteria
1. **Professional Invoices**: Generate VAT-compliant professional invoices
2. **Accurate VAT**: Correct VAT calculation and display
3. **Customer Integration**: Seamless customer and property integration
4. **Payment Tracking**: Complete payment allocation and tracking
5. **Accounting Integration**: Proper integration with accounting system

## Verification

### Pre-Implementation Checks
- [x] Invoices API framework available
- [x] Customer/tenant profiles integration possible
- [x] Property integration available
- [x] VAT calculation requirements understood

### Implementation Verification
- [ ] VAT invoice creation form completed
- [ ] Line item management working correctly
- [ ] VAT calculation system implemented and tested
- [ ] Customer and property integration functional
- [ ] Invoice numbering system working
- [ ] Invoice management screens created
- [ ] Payment integration completed

### Acceptance Criteria
- [ ] Users can create professional VAT invoices
- [ ] VAT is calculated correctly per Saudi regulations
- [ ] Multiple line items are supported
- [ ] Customer and property data integrates seamlessly
- [ ] Invoice status management works correctly
- [ ] Payment tracking and allocation functions properly

## Files Modified

### Files to be Created
- `app/finance/invoices/create.tsx` - VAT invoice creation form
- `app/finance/invoices/index.tsx` - Invoice management and listing
- `app/finance/invoices/[id].tsx` - Invoice detail and edit screen
- `components/InvoiceLineItem.tsx` - Line item management component
- `components/VATCalculator.tsx` - VAT calculation component
- `components/InvoicePreview.tsx` - Invoice preview component

### Files to be Modified
- `lib/api.ts` - Enhance invoices API with VAT and line items
- Navigation files - Add invoice management to finance section
- Type definitions - Add invoice and VAT types

## Notes

This task implements a comprehensive VAT invoice system that complies with Saudi Arabia's VAT regulations (15% standard rate). The system should:

- Generate professional invoices with proper VAT calculation
- Support multiple line items with individual VAT calculation
- Integrate with customer and property management
- Connect to the accounting system for revenue recognition
- Track payment status and outstanding balances
- Support various invoice types (rental, sales, services)

The invoicing system is critical for property management companies to bill tenants for rent, property services, and maintenance charges while maintaining VAT compliance and proper accounting integration. 