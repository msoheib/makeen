# [11-1] Setup Supabase Edge Function Infrastructure for PDF Generation

[Back to task list](mdc:tasks.md)

## Description

Create and deploy a Supabase Edge Function that can receive PDF generation requests, fetch data from the database, and generate PDF files using Puppeteer. This task establishes the foundational server-side infrastructure for the PDF generation system.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----|---|----|-----|---|---|
| 2025-06-15 11:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-06-15 11:05:00 | Status Update | Proposed | Agreed | Task approved for implementation | User |
| 2025-06-15 11:10:00 | Status Update | Agreed | InProgress | Starting Edge Function development | AI_Agent |

## Requirements

### Functional Requirements
- Deploy Edge Function named `pdf-generator` to Supabase project
- Implement HTTP handler for POST requests with PDF generation parameters
- Connect to Supabase database for real-time data fetching
- Generate PDF files using Puppeteer with proper HTML/CSS rendering
- Support all 5 report types: revenue, expense, property, tenant, maintenance
- Return generated PDF as downloadable response

### Technical Requirements
- Use Deno runtime with TypeScript
- Implement proper CORS headers for cross-origin requests
- Add request validation and error handling
- Configure proper timeout settings for PDF generation
- Include logging for debugging and monitoring

### Performance Requirements
- PDF generation should complete within 10 seconds
- Support concurrent requests (multiple users generating PDFs)
- Optimize memory usage during PDF generation
- Handle large datasets efficiently

## Implementation Plan

### Step 1: Create Edge Function Structure
```typescript
// supabase/functions/pdf-generator/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.38.4";
import puppeteer from "https://deno.land/x/puppeteer@16.2.0/mod.ts";
```

### Step 2: Implement Database Connection
- Create Supabase client with service role key
- Implement data fetching functions for each report type
- Add proper error handling for database connections

### Step 3: PDF Generation Logic
- Create HTML templates for each report type
- Implement Puppeteer PDF generation with proper options
- Add company branding and professional styling

### Step 4: Deploy and Test
- Deploy Edge Function using Supabase CLI or MCP tools
- Test with sample requests for each report type
- Verify PDF output quality and data accuracy

## Test Plan

### Unit Tests
- Test data fetching functions for each report type
- Verify PDF generation with sample data
- Test error handling for invalid requests

### Integration Tests
- Test complete flow from request to PDF response
- Verify database connection and data retrieval
- Test Edge Function deployment and availability

### Performance Tests
- Test PDF generation time for different data sizes
- Verify memory usage during concurrent requests
- Test timeout handling for large datasets

## Verification

### Acceptance Criteria
- ✅ Edge Function deployed and accessible
- ✅ All 5 report types supported with real data
- ✅ PDF files generated with proper formatting
- ✅ Error handling and logging implemented
- ✅ Performance meets specified requirements

### Test Cases
1. **PDF Generation Test**: Generate PDF for each report type with real data
2. **Error Handling Test**: Test with invalid parameters and verify error responses
3. **Performance Test**: Generate multiple PDFs concurrently and measure response times
4. **Data Accuracy Test**: Verify PDF content matches database query results

## Files Modified

### New Files
- `supabase/functions/pdf-generator/index.ts` - Main Edge Function code
- `supabase/functions/pdf-generator/deno.json` - Deno configuration
- `supabase/functions/pdf-generator/import_map.json` - Import mappings

### Modified Files
- None (new infrastructure setup)

## Dependencies

- Supabase project with Edge Functions enabled
- Puppeteer library for PDF generation
- Access to production database with sample data
- Supabase CLI or MCP tools for deployment 